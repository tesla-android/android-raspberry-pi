From b9e581244a442eb2dc5ad096d08e2ee865058637 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Micha=C5=82=20Gapi=C5=84ski?= <mike@gapinski.eu>
Date: Tue, 16 May 2023 17:06:03 +0000
Subject: [PATCH 4/5] SoftAp: add option to start tether from shell with stored
 configuration
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Change-Id: I22908c9b6b515100f427182948ffb927ff001a9e
Signed-off-by: Michał Gapiński <mike@gapinski.eu>
---
 .../android/server/wifi/WifiShellCommand.java    | 16 ++++++++++++++++
 1 file changed, 16 insertions(+)

diff --git a/service/java/com/android/server/wifi/WifiShellCommand.java b/service/java/com/android/server/wifi/WifiShellCommand.java
index 8b68e3a..a0e28dc 100644
--- a/service/java/com/android/server/wifi/WifiShellCommand.java
+++ b/service/java/com/android/server/wifi/WifiShellCommand.java
@@ -860,6 +860,20 @@ public class WifiShellCommand extends BasicShellCommandHandler {
                     mWifiService.unregisterLocalOnlyHotspotSoftApCallback(softApCallback, extras);
                     return 0;
                 }
+                case "start-softap-with-existing-config": {
+                    CountDownLatch countDownLatch = new CountDownLatch(1);
+                    SoftApConfiguration config = mWifiApConfigStore.getApConfiguration();
+                    SoftApCallbackProxy softApCallback =
+                            new SoftApCallbackProxy(pw, countDownLatch);
+                    mWifiService.registerSoftApCallback(softApCallback);
+                    if (!mWifiService.startTetheredHotspot(config, SHELL_PACKAGE_NAME)) {
+                        pw.println("Soft AP failed to start. Please check config parameters");
+                    }
+                    // Wait for softap to start and complete callback
+                    countDownLatch.await(10000, TimeUnit.MILLISECONDS);
+                    mWifiService.unregisterSoftApCallback(softApCallback);
+                    return 0;
+                }
                 case "start-softap": {
                     CountDownLatch countDownLatch = new CountDownLatch(1);
                     SoftApConfiguration config = buildSoftApConfiguration(pw);
@@ -3043,6 +3057,8 @@ public class WifiShellCommand extends BasicShellCommandHandler {
         pw.println("    Clears the user disabled networks list.");
         pw.println("  send-link-probe");
         pw.println("    Manually triggers a link probe.");
+        pw.println("  start-softap-with-current-config");
+        pw.println("    Start softap with current/default params");
         pw.println(
                 "  start-softap <ssid> (open|wpa2|wpa3|wpa3_transition|owe|owe_transition)"
                         + " <passphrase> [-b 2|5|6|any|bridged|bridged_2_5|bridged_2_6|bridged_5_6]"
-- 
2.34.1

